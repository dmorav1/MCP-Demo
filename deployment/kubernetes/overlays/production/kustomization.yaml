apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: production

# Base configuration
bases:
  - ../../base

# Common labels for production environment
commonLabels:
  environment: production

# Resource name prefix for blue-green deployment
namePrefix: prod-

# Images to use for production environment
images:
  - name: REGISTRY/mcp-backend
    newName: ghcr.io/dmorav1/mcp-demo-backend
    # Tag will be set by CD pipeline (e.g., v1.2.3)
  - name: REGISTRY/mcp-frontend
    newName: ghcr.io/dmorav1/mcp-demo-frontend
    # Tag will be set by CD pipeline (e.g., v1.2.3)

# ConfigMap for production environment
configMapGenerator:
  - name: app-config
    literals:
      - ENVIRONMENT=production
      - LOG_LEVEL=WARNING
      - DATABASE_HOST=mcp-prod-rds.cluster-xxx.us-east-1.rds.amazonaws.com
      - DATABASE_PORT=5432
      - DATABASE_NAME=mcp_production
      - REDIS_HOST=redis-prod.production.svc.cluster.local
      - REDIS_PORT=6379
      - METRICS_ENABLED=true
      - TRACING_ENABLED=true
      - TRACING_SAMPLE_RATE=0.1
      - CACHE_ENABLED=true
      - CACHE_TTL=3600

# Production secrets MUST be managed by external secret manager
# This is a placeholder configuration - DO NOT use literal secrets in production
secretGenerator:
  - name: app-secrets
    literals:
      - PLACEHOLDER=use_aws_secrets_manager_or_hashicorp_vault

# Patches for production-specific configuration
patches:
  # Backend deployment - production settings
  - target:
      kind: Deployment
      name: mcp-backend
    patch: |-
      - op: replace
        path: /spec/replicas
        value: 3
      - op: add
        path: /spec/template/spec/containers/0/resources
        value:
          requests:
            memory: "1Gi"
            cpu: "1000m"
          limits:
            memory: "2Gi"
            cpu: "2000m"
      - op: add
        path: /spec/template/spec/containers/0/env
        value:
          - name: ENVIRONMENT
            valueFrom:
              configMapKeyRef:
                name: app-config
                key: ENVIRONMENT
          - name: DATABASE_PASSWORD
            valueFrom:
              secretKeyRef:
                name: db-credentials
                key: password
          - name: OPENAI_API_KEY
            valueFrom:
              secretKeyRef:
                name: api-keys
                key: openai
          - name: ANTHROPIC_API_KEY
            valueFrom:
              secretKeyRef:
                name: api-keys
                key: anthropic
      - op: add
        path: /spec/template/spec/affinity
        value:
          podAntiAffinity:
            requiredDuringSchedulingIgnoredDuringExecution:
              - labelSelector:
                  matchExpressions:
                    - key: app
                      operator: In
                      values:
                        - mcp-backend
                topologyKey: topology.kubernetes.io/zone

  # HPA - production scaling settings
  - target:
      kind: HorizontalPodAutoscaler
      name: mcp-backend
    patch: |-
      - op: replace
        path: /spec/minReplicas
        value: 3
      - op: replace
        path: /spec/maxReplicas
        value: 10
      - op: replace
        path: /spec/metrics/0/resource/target/averageUtilization
        value: 60
      - op: add
        path: /spec/behavior
        value:
          scaleDown:
            stabilizationWindowSeconds: 300
            policies:
              - type: Percent
                value: 50
                periodSeconds: 60
          scaleUp:
            stabilizationWindowSeconds: 60
            policies:
              - type: Percent
                value: 100
                periodSeconds: 60
              - type: Pods
                value: 2
                periodSeconds: 60

  # Service - production annotations for load balancer
  - target:
      kind: Service
      name: mcp-backend
    patch: |-
      - op: add
        path: /metadata/annotations
        value:
          service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
          service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: "true"
          service.beta.kubernetes.io/aws-load-balancer-backend-protocol: "http"
          service.beta.kubernetes.io/aws-load-balancer-ssl-ports: "443"

# Additional production-specific resources
resources:
  - pod-disruption-budget.yaml
  - network-policy.yaml
